x-base-config: &base-config
  volumes:
    - ./:/workspace # Hot-reload: mount local code
    - huggingface_cache:/root/.cache/huggingface
    - ./output_audio:/workspace/output_audio
    - uv_cache:/root/.cache/uv # Persist UV cache để tránh download lại packages
    - pip_cache:/root/.cache/pip # Persist pip cache (cho các packages install bằng pip)
  env_file:
    - .env
  stdin_open: true # Support interactive shell
  tty: true
  ports:
    - "${PORT}:${GRADIO_SERVER_PORT}"
  command: ["uv", "run", "gradio_app.py"]

services:
  # ========================================================
  # CPU Profile
  # ========================================================
  cpu:
    <<: *base-config
    profiles: ["cpu"]
    build:
      context: .
      dockerfile: docker/Dockerfile.cpu
      target: dev
    container_name: vieneu-tts-cpu-dev

  # ========================================================
  # GPU Profile
  # ========================================================
  gpu:
    <<: *base-config
    profiles: ["gpu"]
    build:
      context: .
      dockerfile: docker/Dockerfile.gpu
      target: dev
    container_name: vieneu-tts-gpu-dev
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

volumes:
  huggingface_cache:
  uv_cache: # Cache directory cho uv (packages, wheels)
  pip_cache: # Cache directory cho pip (nếu có packages install bằng pip)
